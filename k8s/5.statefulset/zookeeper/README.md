# Statefulset

## Zookeeper

### Setup

```sh
kubectl apply -f zookeeper.yaml
```

* This creates the `zk-hs` Headless Service, the `zk-cs` Service, the `zk-pdb` PodDisruptionBudget, and the `zk` StatefulSet.

```sh
service "zk-hs" created
service "zk-cs" created
poddisruptionbudget "zk-pdb" created
statefulset "zk" created
```

### Inspection

* View the pods created

```sh
kubectl get pods

NAME      READY     STATUS    RESTARTS   AGE
zk-0      1/1       Running   0          2m
zk-1      1/1       Running   0          2m
zk-2      1/1       Running   0          2m
```

* Get the hostnames of the Pods in the `zk` StatefulSet

```sh
for i in 0 1 2; do kubectl exec zk-$i -- hostname; done

zk-0
zk-1
zk-2
```

* Examine the contents of the myid file for each server use the following command

```sh
for i in 0 1 2; do echo "myid zk-$i";kubectl exec zk-$i -- cat /var/lib/zookeeper/data/myid; done

myid zk-0
1
myid zk-1
2
myid zk-2
3
```

* View the zookeeper's application configuration

```sh
kubectl exec zk-0 -- cat /opt/zookeeper/conf/zoo.cfg
```

```sh
#This file was autogenerated DO NOT EDIT
clientPort=2181
dataDir=/var/lib/zookeeper/data
dataLogDir=/var/lib/zookeeper/data/log
tickTime=2000
initLimit=10
syncLimit=5
maxClientCnxns=60
minSessionTimeout=4000
maxSessionTimeout=40000
autopurge.snapRetainCount=3
autopurge.purgeInteval=12
server.1=zk-0.zk-hs.default.svc.cluster.local:2888:3888
server.2=zk-1.zk-hs.default.svc.cluster.local:2888:3888
server.3=zk-2.zk-hs.default.svc.cluster.local:2888:3888
```

### Test the Ensemble

* Write data to `zk-0`

```sh
kubectl exec zk-0 zkCli.sh create /hello world
```

```sh
Connecting to localhost:2181
...
2018-07-26 06:57:27,631 [myid:] - INFO  [main:Environment@100] - Client environment:host.name=zk-0.zk-hs.default.svc.cluster.local
...

WATCHER::

WatchedEvent state:SyncConnected type:None path:null
Created /hello
```

* Read it from `zk-1`

```sh
kubectl exec zk-1 zkCli.sh get /hello
```

```sh
Connecting to localhost:2181
...
2018-07-26 07:00:26,155 [myid:] - INFO  [main:Environment@100] - Client environment:host.name=zk-1.zk-hs.default.svc.cluster.local
...

WATCHER::

WatchedEvent state:SyncConnected type:None path:null
world
...
```

### Test the Durable Storage

* Delete the statefulset

```sh
kubectl delete statefulset zk
statefulset "zk" deleted
```

* Reapply the manifest in zookeeper.yaml

```sh
kubectl apply -f zookeeper.yaml

service "zk-hs" unchanged
service "zk-cs" unchanged
poddisruptionbudget "zk-pdb" unchanged
statefulset "zk" created
```

* Get the `/hello` value from `zk-2`

```sh
kubectl exec zk-2 zkCli.sh get /hello
```

```sh
Connecting to localhost:2181
...
2018-07-26 08:15:22,391 [myid:] - INFO  [main:Environment@100] - Client environment:host.name=zk-2.zk-hs.default.svc.cluster.local
...

WATCHER::

WatchedEvent state:SyncConnected type:None path:null
world
```

### Teardown

```sh
kubectl delete -f zookeeper.yaml
```

[[reference](https://kubernetes.io/docs/tutorials/stateful-application/zookeeper/)]